"""
Telegram-–±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–º –¥–µ–ª (To-Do List).

–ö–æ–º–∞–Ω–¥—ã:
    /start           ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    /help            ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
    /add <–Ω–∞–∑–≤–∞–Ω–∏–µ>  ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
    /list            ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
    /complete <–Ω–æ–º–µ—Ä>‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
    /delete <–Ω–æ–º–µ—Ä>  ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ –Ω–æ–º–µ—Ä—É

–ó–∞–ø—É—Å–∫:
    pip install pyTelegramBotAPI psycopg2-binary python-dotenv
    python bot.py
"""

import os
import telebot
from telebot import types
from dotenv import load_dotenv

import database as db

# ---------------------------------------------------------------------------
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# ---------------------------------------------------------------------------

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()

TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    raise RuntimeError("–ù–µ –∑–∞–¥–∞–Ω BOT_TOKEN –≤ —Ñ–∞–π–ª–µ .env")

bot = telebot.TeleBot(TOKEN)

# –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
db.create_table()


# ---------------------------------------------------------------------------
# /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
# ---------------------------------------------------------------------------

@bot.message_handler(commands=["start"])
def cmd_start(message: types.Message) -> None:
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ –±–æ—Ç–µ."""
    name = message.from_user.first_name or "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    bot.send_message(
        message.chat.id,
        f"üëã –ü—Ä–∏–≤–µ—Ç, {name}!\n\n"
        f"–Ø –±–æ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–º –¥–µ–ª.\n"
        f"–ù–∞–ø–∏—à–∏ /help, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, —á—Ç–æ —è —É–º–µ—é.",
    )


# ---------------------------------------------------------------------------
# /help ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
# ---------------------------------------------------------------------------

@bot.message_handler(commands=["help"])
def cmd_help(message: types.Message) -> None:
    """–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."""
    bot.send_message(
        message.chat.id,
        "üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n\n"
        "/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "/help ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫\n"
        "/add <–Ω–∞–∑–≤–∞–Ω–∏–µ> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É\n"
        "/list ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏\n"
        "/complete <–Ω–æ–º–µ—Ä> ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é\n"
        "/delete <–Ω–æ–º–µ—Ä> ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –ø–æ –Ω–æ–º–µ—Ä—É",
        parse_mode="Markdown",
    )


# ---------------------------------------------------------------------------
# /add <–Ω–∞–∑–≤–∞–Ω–∏–µ> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É
# ---------------------------------------------------------------------------

@bot.message_handler(commands=["add"])
def cmd_add(message: types.Message) -> None:
    """–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ —Å–ø–∏—Å–æ–∫."""
    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã /add
    parts = message.text.split(maxsplit=1)

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–ª –Ω–∞–∑–≤–∞–Ω–∏–µ
    if len(parts) < 2 or not parts[1].strip():
        bot.send_message(
            message.chat.id,
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /add <–Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏>\n"
            "–ü—Ä–∏–º–µ—Ä: /add –ö—É–ø–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã",
        )
        return

    name = parts[1].strip()
    user_id = message.from_user.id

    try:
        task = db.add_task(user_id, name)
        bot.send_message(
            message.chat.id,
            f"‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!\n{task}",
        )
    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏: {e}")


# ---------------------------------------------------------------------------
# /list ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
# ---------------------------------------------------------------------------

@bot.message_handler(commands=["list"])
def cmd_list(message: types.Message) -> None:
    """–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–¥–∞—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    user_id = message.from_user.id

    try:
        tasks = db.get_tasks(user_id)
    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∑–∞–¥–∞—á: {e}")
        return

    if not tasks:
        bot.send_message(
            message.chat.id,
            "üì≠ –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –ø—É—Å—Ç.\n–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –∫–æ–º–∞–Ω–¥–æ–π /add <–Ω–∞–∑–≤–∞–Ω–∏–µ>.",
        )
        return

    lines = ["üìã *–í–∞—à–∏ –∑–∞–¥–∞—á–∏:*\n"]
    for task in tasks:
        lines.append(str(task))

    bot.send_message(message.chat.id, "\n".join(lines), parse_mode="Markdown")


# ---------------------------------------------------------------------------
# /complete <–Ω–æ–º–µ—Ä> ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
# ---------------------------------------------------------------------------

@bot.message_handler(commands=["complete"])
def cmd_complete(message: types.Message) -> None:
    """–û—Ç–º–µ—á–∞–µ—Ç –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é."""
    parts = message.text.split()
    user_id = message.from_user.id

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º
    if len(parts) < 2:
        bot.send_message(
            message.chat.id,
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /complete <–Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏>\n"
            "–ü—Ä–∏–º–µ—Ä: /complete 1",
        )
        return

    try:
        task_id = int(parts[1])
    except ValueError:
        bot.send_message(
            message.chat.id,
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
            f"¬´{parts[1]}¬ª ‚Äî –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º. –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏.",
        )
        return

    try:
        found = db.complete_task(user_id, task_id)
    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return

    if not found:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –∑–∞–¥–∞—á–∞ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        bot.send_message(
            message.chat.id,
            f"‚ùå –¢–∞–∫–æ–π –∑–∞–¥–∞—á–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π /list.",
        )
    else:
        bot.send_message(
            message.chat.id,
            f"‚úÖ –ó–∞–¥–∞—á–∞ ‚Ññ{task_id} –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è!",
        )


# ---------------------------------------------------------------------------
# /delete <–Ω–æ–º–µ—Ä> ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É
# ---------------------------------------------------------------------------

@bot.message_handler(commands=["delete"])
def cmd_delete(message: types.Message) -> None:
    """–£–¥–∞–ª—è–µ—Ç –∑–∞–¥–∞—á—É –ø–æ –Ω–æ–º–µ—Ä—É."""
    parts = message.text.split()
    user_id = message.from_user.id

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –Ω–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω
    if len(parts) < 2:
        bot.send_message(
            message.chat.id,
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /delete <–Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏>\n"
            "–ü—Ä–∏–º–µ—Ä: /delete 1",
        )
        return

    try:
        task_id = int(parts[1])
    except ValueError:
        bot.send_message(
            message.chat.id,
            "‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.\n"
            f"¬´{parts[1]}¬ª ‚Äî –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∏—Å–ª–æ–º. –£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏.",
        )
        return

    try:
        found = db.delete_task(user_id, task_id)
    except Exception as e:
        bot.send_message(message.chat.id, f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return

    if not found:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è: –∑–∞–¥–∞—á–∏ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ—Ç
        bot.send_message(
            message.chat.id,
            f"‚ùå –¢–∞–∫–æ–π –∑–∞–¥–∞—á–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π /list.",
        )
    else:
        bot.send_message(
            message.chat.id,
            f"üóë –ó–∞–¥–∞—á–∞ ‚Ññ{task_id} —É–¥–∞–ª–µ–Ω–∞.",
        )


# ---------------------------------------------------------------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
# ---------------------------------------------------------------------------

@bot.message_handler(func=lambda msg: msg.text and msg.text.startswith("/"))
def cmd_unknown(message: types.Message) -> None:
    """–†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ –ª—é–±—É—é –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É."""
    bot.send_message(
        message.chat.id,
        "‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\n–ù–∞–ø–∏—à–∏ /help, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.",
    )


# ---------------------------------------------------------------------------
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–Ω–µ –∫–æ–º–∞–Ω–¥—ã)
# ---------------------------------------------------------------------------

@bot.message_handler(func=lambda msg: True)
def handle_text(message: types.Message) -> None:
    """–ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã."""
    bot.send_message(
        message.chat.id,
        "‚ÑπÔ∏è –Ø –ø–æ–Ω–∏–º–∞—é —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã.\n–ù–∞–ø–∏—à–∏ /help, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.",
    )


# ---------------------------------------------------------------------------
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# ---------------------------------------------------------------------------

if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    # none_stop=True ‚Äî –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ç–∏
    bot.polling(none_stop=True)
